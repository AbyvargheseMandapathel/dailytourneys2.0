{% extends 'base.html' %}

{% block content %}
  <h2>Add Points to Teams</h2>

  <p>Tournament: <strong>{{ tournament.name }}</strong></p>
  <p>Map: <strong>{{ map_name }}</strong></p>
  <p>Groups: {{ groups|join:", " }}</p>
  <p>Winning Team: <strong>{{ winning_team.name }}</strong></p>

  <form method="post" id="points-form">
    {% csrf_token %}

    <label for="selected_team">Select a Team:</label>
    <select name="selected_team" id="selected_team" required>
      <option value="">Select a Team</option>
      {% for team in teams %}
        <option value="{{ team.id }}">{{ team.name }}</option>
      {% endfor %}
    </select>

    <label for="position_points">Position Points:</label>
    <input type="number" name="position_points" id="position_points" required>

    <label for="finishes_points">Finishes Points:</label>
    <input type="number" name="finishes_points" id="finishes_points" required>

    <button type="button" id="save-button">Save Points</button>
  </form>

  <div id="points-table">
    <h2>Saved Points</h2>
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Position Points</th>
          <th>Finishes Points</th>
          <th>Total Points</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="points-body"></tbody>
    </table>
  </div>

  <!-- Add a button to submit the data to the database -->
  <button type="button" id="submit-to-database">Submit to Database</button>

  <script>
    // Initialize saved points array
    let savedPoints = [];

    // Get references to form elements
    const form = document.getElementById('points-form');
    const saveButton = document.getElementById('save-button');
    const pointsBody = document.getElementById('points-body');
    const submitToDatabaseButton = document.getElementById('submit-to-database');

    // Function to add a row to the table
    function addRowToTable(teamData) {
      const row = pointsBody.insertRow();

      const cellTeam = row.insertCell(0);
      cellTeam.textContent = teamData.selectedTeam;

      const cellPositionPoints = row.insertCell(1);
      cellPositionPoints.textContent = teamData.positionPoints;

      const cellFinishesPoints = row.insertCell(2);
      cellFinishesPoints.textContent = teamData.finishesPoints;

      const cellTotalPoints = row.insertCell(3);
      cellTotalPoints.textContent = teamData.totalPoints;

      const cellAction = row.insertCell(4);
      const deleteAction = document.createElement('button');
      deleteAction.textContent = 'Delete';
      deleteAction.addEventListener('click', function () {
        // Remove the row from the table
        pointsBody.deleteRow(row.rowIndex);

        // Remove the data from the savedPoints array
        savedPoints = savedPoints.filter(data => data !== teamData);

        // Update local storage
        localStorage.setItem('savedPoints', JSON.stringify(savedPoints));
      });

      cellAction.appendChild(deleteAction);

      // Call the sorting function
      sortTable();
    }

    // Sorting function
    function sortTable() {
      const table = document.querySelector('table');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.rows);

      rows.sort((a, b) => {
        const pointsA = parseInt(a.cells[3].textContent);
        const pointsB = parseInt(b.cells[3].textContent);
        return pointsB - pointsA; // Sort by total points
      });

      rows.forEach(row => tbody.appendChild(row));
    }

    // Function to submit data to the server
    submitToDatabaseButton.addEventListener('click', function () {
      // Prepare the data to send
      const data = savedPoints;  // Collect all saved data
      if (data.length === 0) {
        alert('No data to submit.');
        return;
      }
      submitDataToDatabase(data);
    });

    // Function to submit data to the server (AJAX)
    function submitDataToDatabase(data) {
      const url = '/save_points_to_database/';  // Replace with your server endpoint

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'), // Include CSRF token
        },
        body: JSON.stringify(data),
      })
        .then((response) => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Failed to save data to the database');
          }
        })
        .then((responseData) => {
          console.log('Data saved to the database:', responseData);
          showAllSavedTeams();
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    }

    // Function to get CSRF token from cookies
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Function to display all saved teams and details
    function showAllSavedTeams() {
      const allSavedData = savedPoints;
      console.log('All saved teams and details:', allSavedData);
    }

    // Call the function to load saved data from local storage
    loadSavedPoints();

    // Add a click event listener to the Save button
    saveButton.addEventListener('click', function () {
      // Get values from the form
      const selectedTeamId = document.getElementById('selected_team').value;
      const positionPoints = document.getElementById('position_points').value;
      const finishesPoints = document.getElementById('finishes_points').value;

      if (!selectedTeamId || !positionPoints || !finishesPoints) {
        alert('Please fill in all fields.');
        return;
      }

      // Find the team name based on the selected team ID
      const selectedTeam = document.querySelector(`select[name="selected_team"] option[value="${selectedTeamId}"]`).textContent;

      // Create an object to store the values
      const pointsData = {
        selectedTeam,
        positionPoints,
        finishesPoints,
      };

      // Calculate total points
      pointsData.totalPoints = parseInt(pointsData.positionPoints) + parseInt(pointsData.finishesPoints);

      // Add data to the table
      addRowToTable(pointsData);

      // Clear form inputs
      document.getElementById('selected_team').value = '';
      document.getElementById('position_points').value = '';
      document.getElementById('finishes_points').value = '';

      // Store the values in local storage
      savedPoints.push(pointsData);
      localStorage.setItem('savedPoints', JSON.stringify(savedPoints));
    });

    // Function to load saved data from local storage
    function loadSavedPoints() {
      const savedPointsData = localStorage.getItem('savedPoints');
      if (savedPointsData) {
        savedPoints = JSON.parse(savedPointsData);
        savedPoints.forEach(addRowToTable);
      }
    }
  </script>
{% endblock %}

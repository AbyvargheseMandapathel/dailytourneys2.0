{% extends 'base.html' %}

{% block content %}
  <h2>Add Points to Teams</h2>

  <form id="points-form" method="post">
    {% csrf_token %}

    <label for="selected_team">Select a Team:</label>
    <select name="selected_team" id="selected_team">
      <option value="">Select a Team</option>
      {% for team in teams %}
        <option value="{{ team.id }}">{{ team.name }}</option>
      {% endfor %}
    </select>

    <label for="position_points">Position Points:</label>
    <input type="number" name="position_points" id="position_points">

    <label for="finishes_points">Finishes Points:</label>
    <input type="number" name="finishes_points" id="finishes_points">

    <button type="submit" id="save-points-button">Save Points</button>
  </form>

  <div>
    <!-- Display a table of saved points for other teams -->
    <h2>Saved Points</h2>
    <table id="points-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>Position Points</th>
          <th>Finishes Points</th>
          <th>Total Points</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for team_data in teams_data %}
          <tr>
            <td>{{ team_data.team_name }}</td>
            <td>{{ team_data.position_points }}</td>
            <td>{{ team_data.finishes_points }}</td>
            <td>{{ team_data.total_points }}</td>
            <td>
              <!-- Updated button for Delete -->
              <button class="delete-button" data-team-id="{{ team_data.team_id }}">Delete</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Use AJAX to submit the form and update the table
  const form = document.getElementById('points-form');
  const pointsTable = document.getElementById('points-table');
  const savePointsButton = document.getElementById('save-points-button');

  form.addEventListener('submit', function (event) {
    event.preventDefault();

    const selectedTeam = document.getElementById('selected_team').value;
    const positionPoints = document.getElementById('position_points').value;
    const finishesPoints = document.getElementById('finishes_points').value;

    if (!selectedTeam || !positionPoints || !finishesPoints) {
      alert('Please fill in all fields.');
      return;
    }

    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
    })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          // Update the table with sorted data
          const tableBody = pointsTable.querySelector('tbody');
          tableBody.innerHTML = '';

          data.teams_data.forEach(teamData => {
            const row = tableBody.insertRow();
            row.innerHTML = `
              <td>${teamData.team_name}</td>
              <td>${teamData.position_points}</td>
              <td>${teamData.finishes_points}</td>
              <td>${teamData.total_points}</td>
              <td>
                <button class="delete-button" data-team-id="${teamData.team_id}">Delete</button>
              </td>
            `;
          });

          // Remove the entered team from the dropdown
          const dropdown = document.getElementById('selected_team');
          const optionToRemove = dropdown.querySelector(`[value="${selectedTeam}"]`);
          optionToRemove.remove();

          // Add an event listener for the "Delete" buttons again after updating the table
          addDeleteButtonEventListeners();
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  });

  // Add an event listener for the "Delete" buttons
  addDeleteButtonEventListeners();

  function addDeleteButtonEventListeners() {
    pointsTable.addEventListener('click', (event) => {
      if (event.target.classList.contains('delete-button')) {
        const teamId = event.target.getAttribute('data-team-id');
        console.log("Team ID:", teamId); // Check the team ID in the browser console

        // Send an AJAX request to delete the team's scores
        fetch(`/delete_team_scores/${teamId}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCSRFToken() }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Refresh or update the view as needed
              location.reload(); // Refresh the page in this example
            } else if (data.error) {
              alert(data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    });
  }

  function getCSRFToken() {
    const csrfCookie = document.cookie.split("; ").find((cookie) => cookie.startsWith("csrftoken="));
    return csrfCookie ? csrfCookie.split("=")[1] : "";
  }
</script>
{% endblock %}
